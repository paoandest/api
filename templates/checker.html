<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GEO PROJECT - Proxy Checker</title>

    <!-- Fonts & CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Space+Grotesk:wght@400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css" />

    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/jaka2m/mau/refs/heads/kepo/G.png" type="image/x-icon" />

    <style>
        /* Matrix Canvas Overlay */
        #matrixCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            opacity: 0.4;
        }
        
        textarea.form-control {
            font-family: 'Share Tech Mono', monospace;
            min-height: 150px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .controls .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
    </style>
</head>

<body>
    <canvas id="matrixCanvas"></canvas>

    <div class="container">
        <nav class="navbar">
            <a href="/" class="logo">GEO PROJECT</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/checker" class="active">Checker</a>
                <a href="/sub">Sub Link</a>
            </div>
        </nav>

        <div class="card">
            <h2>Proxy Checker</h2>

            <textarea id="input" class="form-control" placeholder="Masukkan proxy manual, contoh: IP:PORT\n..."></textarea>

            <div class="form-group" style="margin-top: 1rem;">
                <input type="file" id="fileInput" class="form-control" multiple accept=".txt" />
            </div>

            <div class="controls">
                <div class="row">
                    <button onclick="startCheck()" class="btn">Mulai Cek</button>
                </div>
                <div class="row">
                    <button onclick="loadFromFiles()" class="btn">Gabungkan Dari File</button>
                    <button onclick="copyToClipboard()" class="btn">Salin Proxy Aktif</button>
                    <button onclick="copyIpPort()" class="btn">Salin IP:Port Aktif</button>
                    <button onclick="downloadTxt()" class="btn">Unduh .txt</button>
                </div>
            </div>

            <div class="status-box" id="stats">
                <div class="status-item"><div>Total</div><h3 id="total">0</h3></div>
                <div class="status-item"><div>Active</div><h3 id="active">0</h3></div>
                <div class="status-item"><div>Inactive</div><h3 id="inactive">0</h3></div>
            </div>

            <div class="table-container">
                <table class="dataTable" style="width:100%">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>IP</th>
                            <th>Port</th>
                            <th>Status</th>
                            <th>Country</th>
                            <th>ISP</th>
                            <th>Protocol</th>
                            <th>Delay</th>
                        </tr>
                    </thead>
                    <tbody id="result"></tbody>
                </table>
            </div>
        </div>
        <footer>
            <p>&copy; 2025 FREE VPN CF</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const canvas = document.getElementById('matrixCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-+=[]{}|;:\'",.<>/?`~';
        const fontSize = 16;
        const columns = canvas.width / fontSize;

        const drops = Array.from({ length: columns }).fill(1);

        function drawMatrix() {
            ctx.fillStyle = 'rgba(2, 13, 26, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = 'var(--color-primary)';
            ctx.font = `${fontSize}px Share Tech Mono`;

            for (let i = 0; i < drops.length; i++) {
                const text = chars.charAt(Math.floor(Math.random() * chars.length));
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }

        setInterval(drawMatrix, 40);

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            drops.length = Math.floor(canvas.width / fontSize);
            drops.fill(1);
        });

        window.onload = () => {
            const saved = localStorage.getItem('proxy_results');
            if (saved) document.getElementById('result').innerHTML = saved;
            const stats = JSON.parse(localStorage.getItem('proxy_stats') || '{}');
            document.getElementById('total').textContent = stats.total || 0;
            document.getElementById('active').textContent = stats.active || 0;
            document.getElementById('inactive').textContent = stats.inactive || 0;
        };

        function saveResultsToLocalStorage() {
            localStorage.setItem('proxy_results', document.getElementById('result').innerHTML);
            localStorage.setItem('proxy_stats', JSON.stringify({
                total: document.getElementById('total').textContent,
                active: document.getElementById('active').textContent,
                inactive: document.getElementById('inactive').textContent
            }));
        }

        async function loadFromFiles() {
            const files = document.getElementById('fileInput').files;
            if (!files.length) return Swal.fire('Info', 'Pilih minimal 1 file .txt', 'info');
            let allText = document.getElementById('input').value.trim();
            for (const file of files) {
                const text = await file.text();
                allText += (allText ? '\n' : '') + text.trim();
            }
            document.getElementById('input').value = allText;
            Swal.fire('Sukses', 'Semua isi file berhasil digabung ke dalam textarea!', 'success');
        }

        async function startCheck() {
            const inputEl = document.getElementById('input');
            const resultTbody = document.getElementById('result');
            const stats = { total: 0, active: 0, inactive: 0 };

            const lines = [...new Set(inputEl.value.trim().split('\n').map(x => x.trim()).filter(Boolean))];
            inputEl.value = lines.join('\n');
            resultTbody.innerHTML = '';
            stats.total = lines.length;
            document.getElementById('total').textContent = stats.total;
            document.getElementById('active').textContent = 0;
            document.getElementById('inactive').textContent = 0;

            for (let i = 0; i < lines.length; i++) {
                const [ip, port] = lines[i].split(':');
                if (!ip || !port) continue;

                const row = resultTbody.insertRow();
                row.insertCell().textContent = i + 1;
                row.insertCell().textContent = ip;
                row.insertCell().textContent = port;
                const statusCell = row.insertCell();
                statusCell.innerHTML = `<span class="status">Checking...</span>`;
                row.insertCell().textContent = '-'; // Country
                row.insertCell().textContent = '-'; // ISP
                row.insertCell().textContent = '-'; // Protocol
                row.insertCell().textContent = '-'; // Delay

                setTimeout(async () => {
                    try {
                        const res = await fetch(`/check?ip=${ip}:${port}`);
                        const data = await res.json();

                        if (data.status === 'ACTIVE') {
                            statusCell.innerHTML = `<span class="status active">Active</span>`;
                            stats.active++;
                        } else {
                            statusCell.innerHTML = `<span class="status inactive">Inactive</span>`;
                            stats.inactive++;
                        }

                        row.cells[4].textContent = data.country || '-';
                        row.cells[5].textContent = data.isp || '-';
                        row.cells[6].textContent = data.httpProtocol || '-';
                        row.cells[7].textContent = data.delay || '-';

                    } catch {
                        statusCell.innerHTML = `<span class="status error">Error</span>`;
                        stats.inactive++;
                    }

                    document.getElementById('active').textContent = stats.active;
                    document.getElementById('inactive').textContent = stats.inactive;
                    saveResultsToLocalStorage();
                }, 200 * i);
            }
        }

        function getActiveProxies(ipPortOnly = false) {
            return Array.from(document.querySelectorAll('#result tr'))
                .filter(r => r.querySelector('.status.active'))
                .map(r => {
                    const cells = r.querySelectorAll('td');
                    if (ipPortOnly) return `${cells[1].textContent}:${cells[2].textContent}`;

                    const country = cells[4].textContent || '-';
                    return [cells[1].textContent, cells[2].textContent, country.split(' ')[0], cells[5].textContent || '-'].join(',');
                })
                .sort((a, b) => (ipPortOnly ? 0 : a.split(',')[2].localeCompare(b.split(',')[2])));
        }

        function copyToClipboard() {
            const proxies = getActiveProxies().join('\n');
            navigator.clipboard.writeText(proxies).then(() => Swal.fire('Sukses', 'Proxy aktif berhasil disalin!', 'success'));
        }

        function copyIpPort() {
            const ipPorts = getActiveProxies(true).join('\n');
            navigator.clipboard.writeText(ipPorts).then(() => Swal.fire('Sukses', 'IP:Port aktif berhasil disalin!', 'success'));
        }

        function downloadTxt() {
            const proxies = getActiveProxies().join('\n');
            const blob = new Blob([proxies], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'active_proxies.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
